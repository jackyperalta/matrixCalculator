Remaining tasks:

add error handlers
set global variables
fix any remaining errors
